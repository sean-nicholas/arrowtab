<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>powertab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"
      integrity="sha512-WFN04846sdKMIP5LKNphMaWzU7YpMyCU245etK3g/2ARYbPK9Ub18eG+ljU96qKRCWh+quCY7yefSmlkQw1ANQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script>
      // TODO: Get all focusable elements
      const getFocusable = () => {
        // Selectors from https://zellwk.com/blog/keyboard-focusable-elements/
        const allFocusable = document.querySelectorAll(
          'a[href], button, input, textarea, select, details, [tabindex]:not([tabindex^="-"])',
        )
        const focusable = Array.from(allFocusable).filter((element) => {
          if (element.disabled) return false
          if (element.hidden) return false
          if (element.getAttribute('aria-hidden') === 'true') return false
          return true
        })
        return focusable
      }

      const getMiddle = (element) => {
        const { x, y, width, height } = element.getBoundingClientRect()
        return {
          x: x + width / 2,
          y: y + height / 2,
        }
      }

      document.addEventListener(
        'keydown',
        (event) => {
          if (
            event.key !== 'ArrowLeft' &&
            event.key !== 'ArrowRight' &&
            event.key !== 'ArrowUp' &&
            event.key !== 'ArrowDown'
          ) {
            return
          }

          // TODO: Ifs should work for textareas
          if (
            event.key === 'ArrowLeft' &&
            !!document.activeElement?.selectionStart &&
            document.activeElement?.selectionStart !== 0
          ) {
            return
          }

          if (
            event.key === 'ArrowRight' &&
            !!document.activeElement?.selectionStart &&
            document.activeElement?.selectionStart !==
              document.activeElement?.value?.length
          ) {
            return
          }

          if (
            (event.key === 'ArrowLeft' || event.key === 'ArrowRight') &&
            !!document.activeElement?.selectionStart &&
            !!document.activeElement?.selectionEnd &&
            document.activeElement?.selectionStart !==
              document.activeElement?.selectionEnd
          ) {
            return
          }

          const activeElement =
            document.activeElement === document.body
              ? getFocusable()?.[0]
              : document.activeElement

          const activePosition = getMiddle(activeElement)

          const allFocusable = getFocusable()

          const candidates = _(allFocusable)
            .filter((element) => element !== activeElement)
            .map((element) => {
              const position = getMiddle(element)

              // Calculate angle between active element and focusable element
              const x = position.x - activePosition.x
              const y = position.y - activePosition.y
              let angle =
                Math.acos(y / Math.sqrt(x ** 2 + y ** 2)) * (180 / Math.PI)
              const direction = x > 0 ? 'right' : 'left'
              if (direction === 'right') {
                angle = 360 - angle
              }

              const distance = Math.sqrt(x ** 2 + y ** 2)

              return {
                element,
                angle,
                position,
                distance,
              }
            })
            .map((focusable) => {
              const { angle } = focusable

              if (event.key === 'ArrowDown' && (angle >= 315 || angle <= 45)) {
                return {
                  ...focusable,
                  withinReach: true,
                }
              }

              if (event.key === 'ArrowLeft' && angle > 45 && angle < 135) {
                return {
                  ...focusable,
                  withinReach: true,
                }
              }

              if (event.key === 'ArrowUp' && angle >= 135 && angle <= 225) {
                return {
                  ...focusable,
                  withinReach: true,
                }
              }

              if (event.key === 'ArrowRight' && angle > 225 && angle < 315) {
                return {
                  ...focusable,
                  withinReach: true,
                }
              }

              return {
                ...focusable,
                withinReach: false,
              }
            })
            .orderBy((f) => f.distance)
            .map((f) => {
              console.log(f)
              return f
            })
            .filter(({ withinReach }) => withinReach)
            .value()

          const nearest = _.first(candidates)

          if (!nearest) {
            return
          }

          nearest.element.focus()
        },
        { capture: true },
      )
    </script>
  </head>
  <body>
    <div class="grid grid-cols-3 gap-4 p-4 items-baseline">
      <input type="text" class="border-2 border-gray-300 p-2" />
      <div>
        <input type="text" hidden class="border-2 border-gray-300 p-2" />
      </div>
      <input type="text" disabled class="border-2 border-gray-300 p-2" />

      <button>Hello</button>
      <button disabled>Hello</button>
      <button aria-hidden="true">Hello</button>
      <a href="#" class="focus:outline">Hello</a>
      <a class="focus:outline">Hello</a>
      <div></div>
      <div tabindex="10">Hello</div>
      <div tabindex="0">Hello</div>
      <div tabindex="-1">Hello</div>
      <input type="text" class="border-2 border-gray-300 p-2" />
      <input type="text" tabindex="0" class="border-2 border-gray-300 p-2" />
      <input type="text" class="border-2 border-gray-300 p-2" />
      <input type="text" class="border-2 border-gray-300 p-2" />
      <input type="text" class="border-2 border-gray-300 p-2" />
    </div>
  </body>
</html>
