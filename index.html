<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>powertab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"
      integrity="sha512-WFN04846sdKMIP5LKNphMaWzU7YpMyCU245etK3g/2ARYbPK9Ub18eG+ljU96qKRCWh+quCY7yefSmlkQw1ANQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script>
      // TODO: Get all focusable elements
      const getFocusable = () => {
        // Selectors from https://zellwk.com/blog/keyboard-focusable-elements/
        const allFocusable = document.querySelectorAll(
          'a[href], button, input, textarea, select, details, [tabindex]:not([tabindex^="-"])',
        )
        const focusable = Array.from(allFocusable).filter((element) => {
          if (element.disabled) return false
          if (element.hidden) return false
          if (element.getAttribute('aria-hidden') === 'true') return false
          return true
        })
        return focusable
      }

      const getMiddle = (element) => {
        const { x, y, width, height } = element.getBoundingClientRect()
        return {
          x: x + width / 2,
          y: y + height / 2,
        }
      }

      document.addEventListener(
        'keydown',
        (event) => {
          const withinReachMetrics = {
            XWalk: ({ angle }) => {
              if (event.key === 'ArrowDown' && (angle >= 315 || angle <= 45)) {
                return true
              }

              if (event.key === 'ArrowLeft' && angle > 45 && angle < 135) {
                return true
              }

              if (event.key === 'ArrowUp' && angle >= 135 && angle <= 225) {
                return true
              }

              if (event.key === 'ArrowRight' && angle > 225 && angle < 315) {
                return true
              }

              return false
            },
          }

          const distanceMetrics = {
            euclidean: ({ xDistance, yDistance }) => {
              return Math.sqrt(xDistance ** 2 + yDistance ** 2)
            },
            manhattan: ({ xDistance, yDistance }) => {
              return Math.abs(xDistance) + Math.abs(yDistance)
            },
            manhattanWeighted: ({ xDistance, yDistance }) => {
              if (event.key === 'ArrowDown' || event.key === 'ArrowUp') {
                return Math.abs(xDistance) + Math.abs(yDistance) * 0.1
              }
              if (event.key === 'ArrowLeft' || event.key === 'ArrowRight') {
                return Math.abs(xDistance) * 0.1 + Math.abs(yDistance)
              }
            },
          }

          const scenarios = {
            XWalkEuclidean: {
              withinReachMetric: withinReachMetrics.XWalk,
              distanceMetric: distanceMetrics.euclidean,
            },
            XWalkManhattan: {
              withinReachMetric: withinReachMetrics.XWalk,
              distanceMetric: distanceMetrics.manhattan,
            },
            XWalkManhattanWeighted: {
              withinReachMetric: withinReachMetrics.XWalk,
              distanceMetric: distanceMetrics.manhattanWeighted,
            },
          }

          const activeScenario = scenarios.XWalkEuclidean

          if (
            event.key !== 'ArrowLeft' &&
            event.key !== 'ArrowRight' &&
            event.key !== 'ArrowUp' &&
            event.key !== 'ArrowDown'
          ) {
            return
          }

          // TODO: Ifs should work for textareas
          if (
            event.key === 'ArrowLeft' &&
            document.activeElement?.selectionStart !== undefined &&
            document.activeElement?.selectionStart !== 0
          ) {
            return
          }

          if (
            event.key === 'ArrowRight' &&
            document.activeElement?.selectionStart !== undefined &&
            document.activeElement?.selectionStart !==
              document.activeElement?.value?.length
          ) {
            return
          }

          if (
            (event.key === 'ArrowLeft' || event.key === 'ArrowRight') &&
            document.activeElement?.selectionStart !== undefined &&
            document.activeElement?.selectionEnd !== undefined &&
            document.activeElement?.selectionStart !==
              document.activeElement?.selectionEnd
          ) {
            return
          }

          const activeElement =
            document.activeElement === document.body
              ? getFocusable()?.[0]
              : document.activeElement

          const activePosition = getMiddle(activeElement)

          const allFocusable = getFocusable()

          const candidates = _(allFocusable)
            .filter((element) => element !== activeElement)
            .map((element) => {
              const position = getMiddle(element)

              // Calculate angle between active element and focusable element
              const xDistance = position.x - activePosition.x
              const yDistance = position.y - activePosition.y
              let angle =
                Math.acos(
                  yDistance / Math.sqrt(xDistance ** 2 + yDistance ** 2),
                ) *
                (180 / Math.PI)
              const direction = xDistance > 0 ? 'right' : 'left'
              if (direction === 'right') {
                angle = 360 - angle
              }

              const distance = Math.sqrt(xDistance ** 2 + yDistance ** 2)

              return {
                xDistance,
                yDistance,
                element,
                angle,
                position,
              }
            })
            .map((focusable) => {
              const distance = activeScenario.distanceMetric(focusable)

              return {
                ...focusable,
                distance,
              }
            })
            .map((focusable) => {
              const withinReach = activeScenario.withinReachMetric(focusable)

              return {
                ...focusable,
                withinReach,
              }
            })
            .orderBy((f) => f.distance)
            .filter(({ withinReach }) => withinReach)
            // .map((f) => {
            //   console.log(f)
            //   return f
            // })
            .value()

          let nearest = _.first(candidates)

          if (!nearest) {
            return
          }

          // const nearlySameDistance = _.filter(candidates, (candidate) => {
          //   return candidate.distance - nearest.distance < 10
          // })

          // console.log('nearlySameDistance', nearlySameDistance)

          // if (nearlySameDistance.length > 1) {
          //   const ordered = _.orderBy(nearlySameDistance, (candidate) => {
          //     if (event.key === 'ArrowDown') {
          //       console.log('ArrowDown', candidate.xDistance)
          //       return -candidate.xDistance
          //     }
          //     if (event.key === 'ArrowUp') {
          //       return candidate.xDistance
          //     }
          //     if (event.key === 'ArrowLeft') {
          //       return candidate.yDistance
          //     }
          //     if (event.key === 'ArrowRight') {
          //       console.log('ArrowRight', candidate.yDistance)
          //       return -candidate.yDistance
          //     }
          //   })
          //   console.log('ordered', ordered)
          //   nearest = _.first(ordered)
          // }

          nearest.element.focus()
        },
        { capture: true },
      )
    </script>
  </head>
  <body>
    <div class="flex flex-col gap-48">
      <div class="grid grid-cols-3 gap-4 p-4 items-baseline">
        <input type="text" class="border-2 border-gray-300 p-2" />
        <input type="text" class="border-2 border-gray-300 p-2" />
        <input type="text" class="border-2 border-gray-300 p-2" />
        <input type="text" class="border-2 border-gray-300 p-2" />
        <input type="text" class="border-2 border-gray-300 p-2" value="Hello" />
        <input type="text" class="border-2 border-gray-300 p-2" />
        <input type="text" class="border-2 border-gray-300 p-2" />
        <input type="text" class="border-2 border-gray-300 p-2" />
        <input type="text" class="border-2 border-gray-300 p-2" />
      </div>

      <div class="grid grid-cols-3 gap-4 p-4 items-baseline">
        <input type="text" class="border-2 border-gray-300 p-2" />
        <input type="text" disabled class="border-2 border-gray-300 p-2" />
        <input type="text" class="border-2 border-gray-300 p-2" />
        <input type="text" disabled class="border-2 border-gray-300 p-2" />
        <input type="text" class="border-2 border-gray-300 p-2" />
        <input type="text" disabled class="border-2 border-gray-300 p-2" />
        <input type="text" class="border-2 border-gray-300 p-2" />
        <input type="text" disabled class="border-2 border-gray-300 p-2" />
        <input type="text" class="border-2 border-gray-300 p-2" />
      </div>

      <div class="grid grid-cols-3 gap-4 p-4 items-baseline">
        <input type="text" class="border-2 border-gray-300 p-2" />
        <div>
          <input type="text" hidden class="border-2 border-gray-300 p-2" />
        </div>
        <input type="text" disabled class="border-2 border-gray-300 p-2" />
        <button>Hello</button>
        <button disabled>Hello</button>
        <button aria-hidden="true">Hello</button>
        <a href="#" class="focus:outline">Hello</a>
        <a class="focus:outline">Hello</a>
        <div></div>
        <div tabindex="10">Hello</div>
        <div tabindex="0">Hello</div>
        <div tabindex="-1">Hello</div>
        <input type="text" class="border-2 border-gray-300 p-2" />
        <input type="text" tabindex="0" class="border-2 border-gray-300 p-2" />
        <input type="text" class="border-2 border-gray-300 p-2" />
        <input type="text" class="border-2 border-gray-300 p-2" />
        <input type="text" class="border-2 border-gray-300 p-2" />
      </div>
    </div>
  </body>
</html>
